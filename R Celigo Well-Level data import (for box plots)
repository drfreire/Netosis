```{r DATA IMPORT}
# Specify how many runs will be included for analysis
runs_included = 1

# Read multiple files and name them for graph legends etc.
read_multiple_files <- function(n_files = runs_included) {
  data_list <- list()

  for(i in 1:n_files) {
    
    # Log
    cat("Selecting file", i, "of", n_files, "\n")

    # Name the Source of the data (which run)
    user_input <- showPrompt(title = "Organizing Data:", message = "Enter dataset name. Next select the corresponding tabular .csv and condition .csv")
    
    # Select data
    file_path <- file.choose()
    data <- read.csv(file_path, skip = 15, header = TRUE, check.names = TRUE) %>%
      dplyr::select(1:39) %>%
      filter((Row %in% LETTERS[1:8]) & (Column %in% 1:12))
    
    # Select, read, and add Condition to data as a new column
    condition_path <- file.choose()
    Condition <- read.csv(condition_path, check.names = FALSE)
    data <- data %>%
    left_join(Condition %>% select(Well, Condition), by = "Well")
    
    # Add a column preserving the Source of the data
    data$Source <- user_input
    data_list[[i]] <- data
    
    # Log
    cat("Combining", file_path, "and", condition_path, "\n")
    cat("Added dataset:", user_input, "\n\n")
  }

  # Combine all datasets
  combined_data <- do.call(rbind, data_list)
  return(combined_data)
}
# Create a datasheet out of combined runs
NET_Data_Combined <- read_multiple_files(runs_included)

# Fix formatting issues
NET_Data_Combined<-mutate(NET_Data_Combined, across(starts_with("X.."), ~as.numeric(gsub("%", "", .x)) / 100))
NET_Data_Combined$Condition <- gsub("\\\\n", "\n", NET_Data_Combined$Condition)
names(NET_Data_Combined) <- gsub("^X\\.\\.", "%", names(NET_Data_Combined))

# Create index columns
NET_Data_Combined$MPO.Index <- as.numeric(NET_Data_Combined$'%MPO') * as.numeric(NET_Data_Combined$'AVG.MPO.Mean.Intensity')
NET_Data_Combined$CitH3.Index <- as.numeric(NET_Data_Combined$'%CitH3') * as.numeric(NET_Data_Combined$'AVG.CitH3.Mean.Intensity')
NET_Data_Combined$DAPI.Index <- as.numeric(NET_Data_Combined$'%DAPI') * as.numeric(NET_Data_Combined$'AVG.DAPI.Mean.Intensity')

# Make sure it's a data table
setDT(NET_Data_Combined)
```
